# VSP v2.12.0 Release Notes

**Date:** 2025-12-07
**Report ID:** 001
**Subject:** abapGit-Compatible File Format & DSL Batch Operations

---

## Executive Summary

v2.12.0 introduces **abapGit-compatible file format support** for class includes and a powerful **DSL batch import/export system** with pipeline builder for RAP deployment automation.

### Key Additions

| Feature | Impact | Use Case |
|---------|--------|----------|
| Class Includes Support | High | Import/export test classes, local definitions |
| Batch Import DSL | High | Deploy entire packages from filesystem |
| Batch Export DSL | High | Backup classes with all includes to files |
| Pipeline Builder | Medium | RAP deployment automation |
| Import Priority Control | Medium | Handle CDS → Class dependencies |

---

## 1. Class Includes Support (abapGit-Compatible)

### Motivation

abapGit stores ABAP classes as multiple files:
- `zcl_foo.clas.abap` - Main class (definition + implementation)
- `zcl_foo.clas.testclasses.abap` - Test classes (CCAU include)
- `zcl_foo.clas.locals_def.abap` - Local type definitions (CCDEF)
- `zcl_foo.clas.locals_imp.abap` - Local class implementations (CCIMP)

Previously, vsp only supported main class files. Now all class includes are supported.

### File Extension Mapping

| Extension | SAP Include | ADT Endpoint |
|-----------|-------------|--------------|
| `.clas.abap` | Main | `/oo/classes/{name}/source/main` |
| `.clas.testclasses.abap` | CCAU | `/oo/classes/{name}/includes/testclasses` |
| `.clas.locals_def.abap` | CCDEF | `/oo/classes/{name}/includes/definitions` |
| `.clas.locals_imp.abap` | CCIMP | `/oo/classes/{name}/includes/implementations` |
| `.clas.macros.abap` | CCMAC | `/oo/classes/{name}/includes/macros` |

### Usage

**ImportFromFile** (auto-detects from extension):
```
ImportFromFile("zcl_test.clas.testclasses.abap", "$TMP")
```

**ExportToFile** (new `include` parameter):
```
ExportToFile(CLAS, "ZCL_TEST", "/tmp", include=testclasses)
```

### Implementation Details

- `fileparser.go`: Added detection for `.clas.testclasses.abap`, `.clas.locals_def.abap`, etc.
- `workflows.go`: `DeployFromFile` and `UpdateFromFile` now handle class includes
- `server.go`: `ExportToFile` supports `include` parameter

---

## 2. DSL Batch Import/Export

### Motivation

Deploying multiple objects manually is tedious. Batch import enables:
- Deploy entire git repos to SAP in one operation
- Maintain correct dependency order
- Handle class includes automatically

### Batch Import

```go
// Import from directory
result, err := dsl.Import(client).
    FromDirectory("./src/").
    ToPackage("$ZRAY").
    WithTransport("DEVK900123").
    Execute(ctx)

// Import specific files in order
result, err := dsl.Import(client).
    FromFilesOrdered(
        "ztravel.ddls.asddls",     // 1st
        "zcl_travel.clas.abap",    // 2nd
        "zcl_travel.clas.testclasses.abap", // 3rd
    ).
    ToPackage("$ZRAY").
    Execute(ctx)
```

### Priority Control

Objects are imported in dependency order:

| Priority | Default | With `RAPOrder()` |
|----------|---------|-------------------|
| 10 | Interfaces | **DDLS** |
| 20 | Classes (main) | **BDEF** |
| 25 | Class includes | Interfaces |
| 30 | Programs | Classes |
| 50 | DDLS | **SRVD** |
| 60 | BDEF | - |
| 70 | SRVD | - |

```go
// DDLS first (when CDS defines types for classes)
dsl.Import(client).FromDirectory("./src/").DDLSFirst().Execute(ctx)

// RAP order (DDLS → BDEF → Classes → SRVD)
dsl.Import(client).FromDirectory("./src/").RAPOrder().Execute(ctx)

// Custom order
dsl.Import(client).FromDirectory("./src/").
    CustomOrder(map[string]int{"DDLS": 1, "CLAS": 2}).Execute(ctx)
```

### Batch Export

```go
// Export class with ALL includes
result, err := dsl.Export(client).
    Classes("ZCL_TRAVEL", "ZCL_BOOKING").
    ToDirectory("./backup/").
    Execute(ctx)

// Creates:
// - zcl_travel.clas.abap
// - zcl_travel.clas.testclasses.abap (if exists)
// - zcl_travel.clas.locals_def.abap (if exists)
// - zcl_travel.clas.locals_imp.abap (if exists)
// - zcl_booking.clas.abap
// - ...
```

---

## 3. Pipeline Builder

### Motivation

RAP development requires a specific sequence:
1. Import CDS views
2. Import behavior definitions
3. Import service definitions
4. Create service bindings
5. Activate all
6. Publish OData service
7. Test

Pipeline builder automates this entire flow.

### Pre-built Pipelines

```go
// Deploy pipeline: import → activate → test
dsl.DeployPipeline(client, "./src/", "$ZRAY")

// RAP pipeline: import → activate → publish → verify
dsl.RAPPipeline(client, "./src/", "$ZRAY", "ZTRAVEL_SB")

// Export pipeline: search → export
dsl.ExportPipeline(client, "$ZRAY*", "./backup/")

// CI pipeline: search → syntax check → test
dsl.CIPipeline(client, "$ZRAY*")
```

### Custom Pipelines

```go
pipeline := dsl.NewPipeline(client, "my-deploy").
    Stage("import").
        Import("./src/", "$ZRAY", "importResults").
        Print("Files imported").
        Then().
    Stage("activate").
        DependsOn("import").
        Search("$ZRAY*", "objects").
        Activate("objects").
        Then().
    Stage("publish").
        DependsOn("activate").
        Publish("ZTRAVEL_SB", "0001").
        Then().
    Stage("test").
        DependsOn("publish").
        Query("SELECT * FROM ZTRAVEL", "data").
        Test("objects", "testResults").
        Then().
    Build()
```

### New Stage Actions

| Action | Description |
|--------|-------------|
| `Import(dir, pkg, saveAs)` | Import all files from directory |
| `ImportFiles(files, pkg, saveAs)` | Import specific files |
| `Create(type, name, pkg, desc)` | Create new object |
| `WriteSource(type, name, srcVar)` | Write source code |
| `ActivateObject(type, name)` | Activate specific object |
| `Publish(binding, version)` | Publish service binding |
| `Unpublish(binding, version)` | Unpublish service binding |
| `Query(sql, saveAs)` | Run SQL query |
| `Export(objVar, dir, saveAs)` | Export objects to files |
| `ExportClasses(names, dir, saveAs)` | Export classes with includes |

---

## 4. Technical Changes

### New Files

- `pkg/dsl/import.go` - Batch import/export implementation (570 LOC)

### Modified Files

| File | Changes |
|------|---------|
| `pkg/adt/fileparser.go` | Class include extension detection |
| `pkg/adt/workflows.go` | `DeployFromFile`, `UpdateFromFile` for includes, `SaveClassIncludeToFile` |
| `pkg/dsl/batch.go` | Pipeline actions: Import, Export, Publish, Query |
| `internal/mcp/server.go` | `ExportToFile` include parameter |

### API Additions

**pkg/adt:**
- `ABAPFileInfo.ClassIncludeType` field
- `SaveClassIncludeToFile(ctx, className, includeType, outputDir)`

**pkg/dsl:**
- `Import(client)` → `ImportBuilder`
- `Export(client)` → `ExportBuilder`
- `ImportDirectory(ctx, client, dir, pkg, transport)`
- `ExportClass(ctx, client, className, outputDir)`
- `ExportClasses(ctx, client, classNames, outputDir)`
- `DeployPipeline(client, sourceDir, pkg)`
- `RAPPipeline(client, sourceDir, pkg, binding)`
- `ExportPipeline(client, pattern, outputDir)`

---

## 5. Use Cases

### Use Case 1: Deploy from Git Repository

```go
// Clone repo, deploy to SAP
result, err := dsl.Import(client).
    FromDirectory("/path/to/git/repo/src/").
    ToPackage("$ZPROJECT").
    RAPOrder().  // CDS first
    Execute(ctx)

fmt.Printf("Imported %d files, %d success\n",
    result.TotalFiles, result.SuccessCount)
```

### Use Case 2: Backup Package to Files

```go
// Export entire package for git commit
result, err := dsl.Export(client).
    Classes("ZCL_FOO", "ZCL_BAR").
    Interfaces("ZIF_FOO").
    DDLSources("ZFOO").
    ToDirectory("./src/").
    Execute(ctx)
```

### Use Case 3: RAP Service Deployment

```go
// Deploy RAP service end-to-end
pipeline := dsl.RAPPipeline(client,
    "./rap-src/",      // Source directory
    "$ZTRAVEL",        // Package
    "ZTRAVEL_SB",      // Service binding
)
// Imports → Activates → Publishes → Verifies
```

### Use Case 4: CI/CD Pipeline

```yaml
# GitHub Actions / GitLab CI
- name: Deploy to SAP
  run: |
    vsp import --directory ./src --package $ZPROJECT --rap-order
    vsp activate --package $ZPROJECT
    vsp test --package $ZPROJECT
```

---

## 6. Statistics

| Metric | Before | After |
|--------|--------|-------|
| Supported file extensions | 8 | 12 (+4 class includes) |
| DSL functions | ~20 | ~35 (+15) |
| Pipeline actions | 8 | 18 (+10) |
| New LOC | - | ~800 |

---

## 7. Compatibility

- **Backward compatible**: All existing APIs unchanged
- **abapGit compatible**: File extensions match abapGit format
- **ADT API**: Uses native ADT endpoints (no workarounds)

---

## 8. Known Limitations

1. **Class includes require existing class**: Cannot import `.clas.testclasses.abap` without the main class existing
2. **No XML metadata**: `.clas.xml` files not supported (metadata via ADT properties)
3. **No table definitions**: `.tabl.xml` requires different ADT API

---

## Next Steps

- [ ] Add `.clas.xml` metadata support
- [ ] Add table/domain/data element support
- [ ] MCP tools for batch import/export
- [ ] YAML workflow support for import/export actions
